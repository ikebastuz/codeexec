<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Go Code Exec</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-2xl">
      <h1 class="text-3xl font-bold mb-6 text-center">Run Code</h1>
      <form id="code-form" class="space-y-4">
        <div>
          <label for="language" class="block font-medium mb-1">Language:</label>
          <select
            name="language"
            id="language"
            class="w-full border rounded px-3 py-2"
          >
            {{range .Languages}}
            <option value="{{.}}">{{.}}</option>
            {{end}}
          </select>
        </div>
        <div>
          <label for="code" class="block font-medium mb-1">Code:</label>
          <textarea
            name="code"
            id="code"
            rows="12"
            class="w-full font-mono border rounded px-3 py-2 text-sm resize-y"
            placeholder="Write your code here..."
            style="display: none"
          ></textarea>
          <div id="code-editor" class="border rounded"></div>
        </div>
        <div class="flex justify-center">
          <button
            id="run-btn"
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Run
          </button>
        </div>
      </form>
      <div id="output-section" class="mt-8">
        <div class="flex items-center justify-center mb-2">
          <h2 class="text-xl font-semibold text-center mr-3">Output</h2>
          <span
            id="build-duration"
            class="text-xs text-gray-500 bg-gray-200 rounded px-2 py-1 mr-1"
            style="display: none"
          >
          </span>
          <span
            id="exec-duration"
            class="text-xs text-gray-500 bg-gray-200 rounded px-2 py-1"
            style="display: none; margin-left: 4px"
          >
          </span>
        </div>
        <div class="mb-4">
          <label class="block font-medium mb-1 text-green-700">Stdout:</label>
          <pre
            id="stdout"
            class="bg-gray-100 border border-green-200 rounded p-3 text-sm overflow-x-auto whitespace-pre-wrap text-green-800"
          ></pre>
        </div>
        <div>
          <label class="block font-medium mb-1 text-red-700">Stderr:</label>
          <pre
            id="stderr"
            class="bg-gray-100 border border-red-200 rounded p-3 text-sm overflow-x-auto whitespace-pre-wrap text-red-800"
          ></pre>
        </div>
        <div
          id="error-section"
          class="mt-2 text-center text-red-600 font-semibold"
        ></div>
      </div>
    </div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/go/go.min.js"></script>
    <script>
      window.sampleCodeMap = JSON.parse("{{ .SampleCodeMap }}");

      const languageSelect = document.getElementById("language");
      const codeTextarea = document.getElementById("code");
      const runBtn = document.getElementById("run-btn");
      const execDurationElem = document.getElementById("exec-duration");
      const buildDurationElem = document.getElementById("build-duration");

      const modeMap = {
        python: "python",
        javascript: "javascript",
        typescript: "javascript",
        java: "text/x-java",
        go: "go",
        golang: "go",
      };
      const codeMirror = CodeMirror(document.getElementById("code-editor"), {
        value: "",
        lineNumbers: true,
        mode: modeMap[languageSelect.value] || "python",
        theme: "default",
        indentUnit: 4,
        tabSize: 4,
        autofocus: true,
      });

      function setSampleCode() {
        const lang = languageSelect.value;
        if (window.sampleCodeMap[lang]) {
          codeMirror.setValue(window.sampleCodeMap[lang]);
        } else {
          codeMirror.setValue("");
        }
        codeMirror.setOption("mode", modeMap[lang] || "python");
      }

      function setDuration(element, duration, label) {
        if (typeof duration === "number" && duration > 0) {
          element.textContent = `${label}: ${duration.toFixed(2)}s`;
          element.style.display = "inline-block";
        } else {
          element.textContent = "";
          element.style.display = "none";
        }
      }

      document
        .getElementById("code-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          runBtn.disabled = true;
          runBtn.textContent = "Running...";
          // Set textarea value from CodeMirror before creating FormData
          codeTextarea.value = codeMirror.getValue();
          const form = e.target;
          const data = new FormData(form);
          const resp = await fetch("/run", {
            method: "POST",
            headers: { Accept: "application/json" },
            body: data,
          });
          const result = await resp.json();
          document.getElementById("stdout").textContent = result.stdout || "";
          document.getElementById("stderr").textContent = result.stderr || "";
          document.getElementById("error-section").textContent =
            result.error || "";

          setDuration(execDurationElem, result.exec_duration, "Execution");
          setDuration(buildDurationElem, result.build_duration, "Build");

          runBtn.disabled = false;
          runBtn.textContent = "Run";
        });

      languageSelect.addEventListener("change", setSampleCode);
      setSampleCode();
    </script>
  </body>
</html>
